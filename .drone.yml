---
kind: pipeline
type: docker
name: test

steps:
- name: test
  image: golang:1.19-alpine3.16
  commands:
  - apk add --no-cache build-base
  - go test -v ./...
  - go build
  when:
    event:
    - pull_request
- name: security
  image: golang:1.19-alpine3.16
  commands:
    - wget -O - -q https://raw.githubusercontent.com/securego/gosec/master/install.sh | sh -s v2.13.1
    - ./bin/gosec ./...
trigger:
  event:
    - pull_request

---
kind: pipeline
type: docker
name: release

steps:
- name: test
  image: golang:1.19-alpine3.16
  commands:
    - apk add --no-cache build-base
    - go test -v ./...
- name: build
  image: golang:1.19-alpine3.16
  commands:
    - apk add --no-cache build-base bash
    - bash ./scripts/build-multiplatform.sh ${DRONE_TAG##v}
    - ls -l flowgre_*
- name: security
  image: golang:1.19-alpine3.16
  commands:
    - wget -O - -q https://raw.githubusercontent.com/securego/gosec/master/install.sh | sh -s v2.13.1
    - ./bin/gosec ./...
- name: release
  image: plugins/github-release
  settings:
    api_key:
      from_secret: GITHUB_TOKEN
    files:
      - flowgre_*
    note: 'Flowgre, version ${DRONE_TAG}'
    title: '${DRONE_TAG}'
    prerelease: true
trigger:
  ref:
    - refs/tags/*
---
kind: signature
hmac: b8a1424c1acd9c526c90d4aeafe2b8592a43ddedcc666958a2dc0e5dfb2296ae

...
